name: W3C CSS Validator (Post-Deploy)

# Questo workflow parte dopo che il workflow di Pages build è completato
on:
  workflow_run:
    workflows: ["pages-build-deployment"]
    types:
      - completed

jobs:
  css-validation:
    runs-on: ubuntu-latest
    # Viene eseguito solo se il workflow precedente è andato a buon fine
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout del codice
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Installa dipendenze
        run: npm install glob node-fetch@2

      - name: Esegui Validazione CSS W3C sulle pagine online
        uses: actions/github-script@v6
        with:
          script: |
            const glob = require('glob');
            const fetch = require('node-fetch');
            const core = require('@actions/core');

            // CONFIGURAZIONE
            const BASE_URL = 'https://youngdord3.github.io/TecWeb/';
            const W3C_API = 'https://jigsaw.w3.org/css-validator/validator';

            const files = glob.sync('**/*.html', { ignore: 'node_modules/**' });
            console.log(`Trovate ${files.length} pagine. Inizio verifica diretta API W3C...`);

            let hasErrors = false;

            const checkUrl = async (pageUrl, filePath) => {
              const apiUrl = `${W3C_API}?uri=${encodeURIComponent(pageUrl)}&output=json&profile=css3svg&usermedium=all&warning=1&lang=it`;
              try {
                const response = await fetch(apiUrl, {
                  headers: { 'User-Agent': 'Mozilla/5.0 (GitHub Action)' }
                });

                if (!response.ok) {
                  throw new Error(`W3C Server Error: ${response.status}`);
                }

                const data = await response.json();
                const result = data.cssvalidation;

                if (result.validity) {
                  console.log(`✅ OK: ${filePath}`);
                } else {
                  console.log(`❌ ERRORI su: ${filePath}`);
                  hasErrors = true;

                  const errors = Array.isArray(result.errors) ? result.errors : [result.errors];
                  if (errors && errors.length > 0) {
                    errors.forEach(err => {
                      const cleanMsg = err.message ? err.message.replace(/\s+/g, ' ').trim() : 'Errore generico';
                      const sourceUri = err.source ? err.source : pageUrl;
                      console.log(`URI : ${sourceUri}`);
                      console.log(`   |-> : ${cleanMsg}`);
                      console.log(''); // Riga vuota per separare visivamente gli errori
                    });
                  } else {
                    console.log(`   -> Errore generico rilevato (controlla output W3C manuale)`);
                  }
                  console.log('--------------------------------------------------');
                }
              } catch (e) {
                console.log(`⚠️ Errore durante la chiamata API per ${filePath}: ${e.message}`);
              }
            };

            const delay = ms => new Promise(res => setTimeout(res, ms));

            (async () => {
              for (const file of files) {
                const cleanPath = file.replace(/\\/g, '/');
                const fullUrl = BASE_URL + cleanPath;
                await checkUrl(fullUrl, cleanPath);
                await delay(500); // evita troppi richiami rapidi al W3C
              }

              if (hasErrors) {
                core.setFailed('Trovati errori CSS sulle pagine online.');
              } else {
                console.log("Tutte le pagine online sono valide!");
              }
            })();
