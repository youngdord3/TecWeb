name: W3C CSS Validator (Post-Deploy)

on:
  workflow_run:
    workflows: ["pages-build-deployment"]
    types:
      - completed

jobs:
  css-validation:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout del codice
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Installa dipendenze
        run: npm install glob node-fetch@2

      - name: Esegui Validazione CSS Online
        uses: actions/github-script@v6
        with:
          script: |
            const glob = require('glob');
            const fetch = require('node-fetch');

            const BASE_URL = 'https://youngdord3.github.io/TecWeb/';
            const W3C_API = 'https://jigsaw.w3.org/css-validator/validator';

            const files = glob.sync('**/*.html', { ignore: 'node_modules/**' });
            console.log(`Trovate ${files.length} pagine. Inizio verifica W3C...`);

            const delay = ms => new Promise(res => setTimeout(res, ms));

            for (const file of files) {
              const cleanPath = file.replace(/\\/g, '/');
              const fullUrl = BASE_URL + cleanPath;

              try {
                const apiUrl = `${W3C_API}?uri=${encodeURIComponent(fullUrl)}&output=json&profile=css3svg&usermedium=all&warning=1&lang=it`;
                const response = await fetch(apiUrl, { headers: { 'User-Agent': 'Mozilla/5.0 (GitHub Action)' } });
                const data = await response.json();
                const result = data.cssvalidation;

                if (result.validity) {
                  console.log(`✅ OK: ${cleanPath}`);
                } else {
                  console.log(`❌ ERRORI su: ${cleanPath}`);
                  const errors = Array.isArray(result.errors) ? result.errors : [result.errors];
                  errors.forEach(err => {
                    const cleanMsg = err.message ? err.message.replace(/\s+/g, ' ').trim() : 'Errore generico';
                    const sourceUri = err.source || fullUrl;
                    console.log(`URI : ${sourceUri}`);
                    console.log(`   |-> : ${cleanMsg}`);
                  });
                  console.log('--------------------------------------------------');
                }

              } catch (e) {
                console.log(`⚠️ Errore durante la chiamata API per ${cleanPath}: ${e.message}`);
              }

              await delay(500);
            }

            console.log("✅ Validazione completata (il job non fallisce, controlla i log per eventuali errori).");
