name: Lighthouse CI - log only

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  lighthouse:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install Node tools
        run: |
          npm install -g lighthouse serve

      - name: Start static server
        run: |
          serve -s . -l 8080 &
          sleep 3

      - name: Run Lighthouse on all HTML files and print scores
        run: |
          for f in $(find . -name "*.html"); do
            url="http://localhost:8080/${f#./}"
            echo "------------------------------------------------------------"
            echo "Running Lighthouse on: $url"
            echo "------------------------------------------------------------"

            # Esegue Lighthouse e prende output JSON in memoria
            npx lighthouse "$url" --output=json --quiet --chrome-flags="--headless --no-sandbox" > lhci_tmp.json

            # Legge JSON e stampa punteggi
            node -e "
              const fs = require('fs');
              const data = JSON.parse(fs.readFileSync('lhci_tmp.json'));
              const cats = data.categories;
              for (const c in cats) { console.log(c + ': ' + cats[c].score); }
            "
          done
