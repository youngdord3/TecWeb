name: Lighthouse CI - log only

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  lighthouse:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install Node tools
        run: |
          npm install -g @lhci/cli serve

      - name: Start static server
        run: |
          serve -s . -l 8080 &
          sleep 3

      - name: Find all HTML files
        id: findhtml
        run: |
          echo "Generating URL list..."
          > urls.txt
          for f in $(find . -name "*.html"); do
            url="http://localhost:8080/${f#./}"
            echo "$url" >> urls.txt
          done
          echo "Found URLs:"
          cat urls.txt

      - name: Run Lighthouse on all HTML files and print scores
        run: |
          while read url; do
            echo "------------------------------------------------------------"
            echo "Running Lighthouse on: $url"
            echo "------------------------------------------------------------"

            # Esegue Lighthouse e prende solo l'output JSON in memory
            output=$(lhci collect --url="$url" --output=json --quiet)

            # Stampa i punteggi principali
            echo "Lighthouse scores for $url:"
            node -e "
              const data = JSON.parse(process.argv[1]);
              const categories = data.categories;
              for (const cat in categories) {
                console.log(cat + ': ' + categories[cat].score);
              }
            " "$output"

          done < urls.txt
