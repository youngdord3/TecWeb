name: Lighthouse CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  lighthouse:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install Node tools
        run: |
          npm install -g @lhci/cli serve

      - name: Start static server
        run: |
          serve -s . -l 8080 &
          sleep 3

      - name: Find all HTML files
        id: findhtml
        run: |
          echo "Generating URL list..."
          > urls.txt
          for f in $(find . -name "*.html"); do
            url="http://localhost:8080/${f#./}"
            echo "$url" >> urls.txt
          done
          echo "Found URLs:"
          cat urls.txt

      - name: Run Lighthouse on all HTML files
        run: |
          while read url; do
            echo "------------------------------------------------------------"
            echo "Running Lighthouse on: $url"
            echo "------------------------------------------------------------"
            lhci collect --url="$url" || true
          done < urls.txt

          echo "Running LHCI assertions (won't stop workflow if failing)..."
          lhci assert || true

          echo "Uploading results (if LHCI server not configured, this is fine)..."
          lhci upload || true
